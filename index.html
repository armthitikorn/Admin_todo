<!DOCTYPE html>

<html lang="th">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Dashboard Roleplay Table</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<style>
    body {
      background: linear-gradient(to right, #74ebd5, #ACB6E5);
      font-family: 'Segoe UI', sans-serif;
    }
    .card {
      animation: fadeIn 0.8s ease-in-out;
      margin-top: 20px;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    .table-responsive {
      margin-top: 20px;
    }
    .login-container {
      max-width: 400px;
      margin: 80px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
<div class="login-container" id="loginSection">
<h4 class="text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h4>
<div class="mb-3">
<label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
<input class="form-control" id="username" type="text"/>
</div>
<div class="mb-3">
<label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
<input class="form-control" id="password" type="password"/>
</div>
<button class="btn btn-primary w-100" onclick="login()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>
<div class="container" id="dashboardSection" style="display:none;">
<div class="card">
<div class="card-body">
<h4 class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö Roleplay</h4>
<div class="row mb-3">
<div class="col-md-4">
<label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
<input class="form-control" id="filterDate" type="date"/>
</div>
<div class="col-md-4 d-flex align-items-end">
<button class="btn btn-success" onclick="exportCSV()">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CSV</button>
</div>
</div>
<div class="table-responsive">

<div style="margin: 20px 0;">
<button onclick="exportToExcel()" style="padding: 10px 20px; margin-right: 10px;">üìä Export to Excel</button>
<button onclick="exportToPDF()" style="padding: 10px 20px;">üìÑ Export to PDF</button>
</div>
<table class="table table-bordered table-striped" id="resultsTable">
<thead class="table-dark">
<tr>
<th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö</th>
<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏≥</th>
<th>‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á</th>
<th>‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤</th>
</tr>
</thead>
<tbody id="resultsBody"></tbody>
</table>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
    const supabase = supabase.createClient(
      'https://wzwyotzzxycqfwercakh.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno'
    );

    function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      if (user === 'admin' && pass === '123456') {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';
        loadData();
      } else {
        alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    }

    async function loadData() {
      const { data: quizResults } = await supabase.from('Quiz_results').select('*');
      const { data: subjectiveAnswers } = await supabase.from('subjective_answers').select('*');
      const { data: tableAudios } = await supabase.from('table_audios').select('*');

      const tableBody = document.getElementById('resultsBody');
      tableBody.innerHTML = '';

      quizResults.forEach(result => {
        const answer = subjectiveAnswers.find(a => a.name === result.name);
        const audio = tableAudios.find(a => a.name === result.name);
        const createdAt = new Date(result.created_at).toLocaleString();

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${result.name}</td>
          <td>${result.total_questions}</td>
          <td><a href="${audio?.audio_url || '#'}" target="_blank">üîä ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a></td>
          <td><a href="${answer?.answer_url || '#'}" target="_blank">üìÑ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</a></td>
          <td>${createdAt}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function exportCSV() {
      const rows = [['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≠‡∏ö','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ó‡∏≥','‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á','‡πÑ‡∏ü‡∏•‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà-‡πÄ‡∏ß‡∏•‡∏≤']];
      document.querySelectorAll('#resultsBody tr').forEach(tr => {
        const cols = Array.from(tr.children).map(td => td.innerText);
        rows.push(cols);
      });
      const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "roleplay_results.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
function exportToExcel() {
    const table = document.getElementById("resultsTable");
    const wb = XLSX.utils.table_to_book(table, {sheet:"Results"});
    XLSX.writeFile(wb, "Roleplay_Results.xlsx");
}

function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const table = document.getElementById("resultsTable");
    let rows = [];
    let headers = [];

    // Get headers
    table.querySelectorAll("thead th").forEach(th => headers.push(th.innerText));
    rows.push(headers);

    // Get rows
    table.querySelectorAll("tbody tr").forEach(tr => {
        let row = [];
        tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
        rows.push(row);
    });

    // Add to PDF
    let startY = 10;
    rows.forEach((row, i) => {
        row.forEach((cell, j) => {
            doc.text(cell, 10 + j * 40, startY + i * 10);
        });
    });

    doc.save("Roleplay_Results.pdf");
}
</script>
</body>
</html>
