<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Roleplay Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #74ebd5, #ACB6E5);
    }
    .container {
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .export-buttons {
      margin-top: 10px;
    }
    .export-buttons button {
      margin-right: 10px;
      padding: 8px 12px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>ðŸ“Š Roleplay Test Dashboard</h2>
      <table id="resultsTable">
        <thead>
          <tr>
            <th>à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸‚à¹‰à¸²à¸ªà¸­à¸š</th>
            <th>à¸ˆà¸³à¸™à¸§à¸™à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸—à¸³</th>
            <th>à¹„à¸Ÿà¸¥à¹Œà¹€à¸ªà¸µà¸¢à¸‡</th>
            <th>à¹„à¸Ÿà¸¥à¹Œà¸„à¸³à¸•à¸­à¸š</th>
            <th>à¸§à¸±à¸™à¸—à¸µà¹ˆ-à¹€à¸§à¸¥à¸²</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="export-buttons">
        <button onclick="exportToExcel()">Export to Excel</button>
        <button onclick="exportToPDF()">Export to PDF</button>
      </div>
    </div>
  </div>

  <script>
    const supabaseUrl = 'https://wzwyotzzxycqfwercakh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3lvdHp6eHljcWZ3ZXJjYWtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTg3MTMsImV4cCI6MjA3MjYzNDcxM30.lgiAf9oBUqsaWGb3u_80wuoKAODQHE_lIBxpGumhrno';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    async function fetchData() {
      const [quizRes, subjectiveRes, audioRes] = await Promise.all([
        supabase.from('Quiz_results').select('*'),
        supabase.from('subjective_answers').select('*'),
        supabase.from('table_audios').select('*')
      ]);

      if (quizRes.error || subjectiveRes.error || audioRes.error) {
        console.error('Error fetching data:', quizRes.error || subjectiveRes.error || audioRes.error);
        return;
      }

      const tableBody = document.querySelector('#resultsTable tbody');
      tableBody.innerHTML = '';

      quizRes.data.forEach(entry => {
        const name = entry.name;
        const count = entry.total_questions || '-';
        const audio = audioRes.data.find(a => a.name === name);
        const answer = subjectiveRes.data.find(a => a.name === name);
        const audioUrl = audio ? audio.audio_url : '-';
        const answerUrl = answer ? answer.answer_url : '-';
        const timestamp = entry.created_at ? new Date(entry.created_at).toLocaleString() : '-';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${name}</td>
          <td>${count}</td>
          <td>${audioUrl !== '-' ? `<a href="${audioUrl}" target="_blank">ðŸ”Š à¸Ÿà¸±à¸‡à¹€à¸ªà¸µà¸¢à¸‡</a>` : '-'}</td>
          <td>${answerUrl !== '-' ? `<a href="${answerUrl}" target="_blank">ðŸ“„ à¸„à¸³à¸•à¸­à¸š</a>` : '-'}</td>
          <td>${timestamp}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    fetchData();

    supabase.channel('dashboard_updates')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'Quiz_results' }, payload => fetchData())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'subjective_answers' }, payload => fetchData())
      .on('postgres_changes', { event: '*', schema: 'public', table: 'table_audios' }, payload => fetchData())
      .subscribe();

    function exportToExcel() {
      const table = document.getElementById('resultsTable');
      const wb = XLSX.utils.table_to_book(table, { sheet: "Results" });
      XLSX.writeFile(wb, 'roleplay_results.xlsx');
    }

    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Roleplay Test Results", 14, 16);
      const rows = [];
      document.querySelectorAll("#resultsTable tbody tr").forEach(tr => {
        const row = [];
        tr.querySelectorAll("td").forEach(td => row.push(td.innerText));
        rows.push(row);
      });
      doc.autoTable({
        head: [['à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸‚à¹‰à¸²à¸ªà¸­à¸š', 'à¸ˆà¸³à¸™à¸§à¸™à¸‚à¹‰à¸­à¸—à¸µà¹ˆà¸—à¸³', 'à¹„à¸Ÿà¸¥à¹Œà¹€à¸ªà¸µà¸¢à¸‡', 'à¹„à¸Ÿà¸¥à¹Œà¸„à¸³à¸•à¸­à¸š', 'à¸§à¸±à¸™à¸—à¸µà¹ˆ-à¹€à¸§à¸¥à¸²']],
        body: rows,
        startY: 20
      });
      doc.save("roleplay_results.pdf");
    }
  </script>
</body>
</html
